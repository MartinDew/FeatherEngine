name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-linux:
    name: Linux Build (${{ matrix.config }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config: [ Debug, Release, Development ]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build

      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '4.1.x'

      - name: Setup C++
        uses: aminya/setup-cpp@v1
        with:
          compiler: gcc

      - name: Setup SDL
        uses: libsdl-org/setup-sdl@main
        id: sdl
        with:
          install-linux-dependencies: true
          version: 3-latest
          version-sdl-image: 3-latest

      - name: Setup Vulkan SDK
        uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-use-cache: true
          vulkan-query-version: latest

      - name: Cache CMake configuration
        uses: actions/cache@v4
        with:
          path: |
            build/${{ matrix.config == 'Debug' && 'debug' || matrix.config == 'Release' && 'release' || 'development' }}/CMakeCache.txt
            build/${{ matrix.config == 'Debug' && 'debug' || matrix.config == 'Release' && 'release' || 'development' }}/CMakeFiles
            build/${{ matrix.config == 'Debug' && 'debug' || matrix.config == 'Release' && 'release' || 'development' }}/*.cmake
          key: linux-cmake-${{ matrix.config }}-${{ hashFiles('**/CMakeLists.txt', 'cmake/**') }}
          restore-keys: |
            linux-cmake-${{ matrix.config }}-

      - name: Configure CMake
        run: |
          cmake --version
          cmake --preset ${{ matrix.config == 'Debug' && 'debug' || matrix.config == 'Release' && 'release' || 'development' }}

      - name: Build Editor
        run: |
          cmake --build --preset ${{ matrix.config == 'Debug' && 'debug' || matrix.config == 'Release' && 'release' || 'development' }} --target Editor

      - name: Build Standalone
        run: |
          cmake --build --preset ${{ matrix.config == 'Debug' && 'debug' || matrix.config == 'Release' && 'release' || 'development' }}  --target Standalone

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.config }}-binaries
          path: |
            build/*/bin/*
          retention-days: 7

  build-windows:
    name: Windows Build (${{ matrix.config }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        config: [ Debug, Release, Development ]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Setup Cmake
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' --yes
          cmake --version

      - name: Setup Clang-CL environment
        run: |
          echo "CC=clang-cl" >> $env:GITHUB_ENV
          echo "CXX=clang-cl" >> $env:GITHUB_ENV
          echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH

      - name: Verify compiler
        run: |
          clang-cl --version
          cmake --version
        shell: pwsh

      - name: Cache CMake configuration
        uses: actions/cache@v4
        with:
          path: |
            build/windows/CMakeCache.txt
            build/windows/CMakeFiles
            build/windows/*.cmake
          key: windows-cmake-${{ matrix.config }}-${{ hashFiles('**/CMakeLists.txt', 'cmake/**') }}
          restore-keys: |
            windows-cmake-${{ matrix.config }}-

      - name: Configure CMake with Clang-CL
        run: |
          cmake --preset windows -T ClangCL
        shell: pwsh

      - name: Build Editor (${{ matrix.config }})
        run: |
          cmake --build build/windows --config ${{ matrix.config }} --target Editor
        shell: pwsh

      - name: Build Standalone (${{ matrix.config }})
        run: |
          cmake --build build/windows --config ${{ matrix.config }} --target Standalone
        shell: pwsh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.config }}-binaries
          path: |
            build/windows/bin/${{ matrix.config }}/*
          retention-days: 7

  build-macos:
    name: macOS Build (${{ matrix.config }})
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        config: [ Debug, Release, Development ]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install latest LLVM
        run: |
          brew install llvm@19 ninja
          echo "$(brew --prefix llvm@19)/bin" >> $GITHUB_PATH

      - name: Set Clang as default compiler
        run: |
          echo "CC=$(brew --prefix llvm@19)/bin/clang" >> $GITHUB_ENV
          echo "CXX=$(brew --prefix llvm@19)/bin/clang++" >> $GITHUB_ENV

      - name: Verify compiler version
        run: |
          $(brew --prefix llvm@19)/bin/clang++ --version
          cmake --version

      - name: Cache CMake configuration
        uses: actions/cache@v4
        with:
          path: |
            build/${{ matrix.config == 'Debug' && 'debug' || matrix.config == 'Release' && 'release' || 'development' }}/CMakeCache.txt
            build/${{ matrix.config == 'Debug' && 'debug' || matrix.config == 'Release' && 'release' || 'development' }}/CMakeFiles
            build/${{ matrix.config == 'Debug' && 'debug' || matrix.config == 'Release' && 'release' || 'development' }}/*.cmake
          key: macos-cmake-${{ matrix.config }}-${{ hashFiles('**/CMakeLists.txt', 'cmake/**') }}
          restore-keys: |
            macos-cmake-${{ matrix.config }}-


      - name: Configure CMake
        run: |
          cmake --preset ${{ matrix.config == 'Debug' && 'debug' || matrix.config == 'Release' && 'release' || 'development' }}

      - name: Build Editor
        run: |
          cmake --build --preset ${{ matrix.config == 'Debug' && 'debug' || matrix.config == 'Release' && 'release' || 'development' }} --target Editor

      - name: Build Standalone
        run: |
          cmake --build --preset ${{ matrix.config == 'Debug' && 'debug' || matrix.config == 'Release' && 'release' || 'development' }} --target Standalone

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.config }}-binaries
          path: |
            build/*/bin/*
          retention-days: 7

  build-android:
    name: Android Build (${{ matrix.config }}, ${{ matrix.abi }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config: [ Debug, Release, Development ]
        abi: [ arm64-v8a, armeabi-v7a, x86_64 ]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r27
          add-to-path: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build

      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '4.1.x'

      - name: Setup Vulkan SDK
        uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-use-cache: true
          vulkan-query-version: latest

      - name: Cache CMake configuration
        uses: actions/cache@v4
        with:
          path: |
            build/android-${{ matrix.abi }}/CMakeCache.txt
            build/android-${{ matrix.abi }}/CMakeFiles
            build/android-${{ matrix.abi }}/*.cmake
          key: android-cmake-${{ matrix.abi }}-${{ matrix.config }}-${{ hashFiles('**/CMakeLists.txt', 'cmake/**') }}
          restore-keys: |
            android-cmake-${{ matrix.abi }}-${{ matrix.config }}-

      - name: Configure CMake for Android
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          cmake --version
          cmake -B build/android-${{ matrix.abi }} \
            -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-24 \
            -DCMAKE_BUILD_TYPE=${{ matrix.config }} \
            -DCMAKE_ANDROID_NDK=$ANDROID_NDK_HOME

      - name: Build Standalone
        run: |
          cmake --build build/android-${{ matrix.abi }} --config ${{ matrix.config }} --target Standalone

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.abi }}-${{ matrix.config }}-binaries
          path: |
            build/android-${{ matrix.abi }}/bin/*
            build/android-${{ matrix.abi }}/lib/*
          retention-days: 7

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [ build-linux, build-windows, build-macos, build-android ]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          echo "Linux build: ${{ needs.build-linux.result }}"
          echo "Windows build: ${{ needs.build-windows.result }}"
          echo "macOS build: ${{ needs.build-macos.result }}"
          echo "Android build: ${{ needs.build-android.result }}"
          
          if [ "${{ needs.build-linux.result }}" != "success" ] || \
             [ "${{ needs.build-windows.result }}" != "success" ] || \
             [ "${{ needs.build-macos.result }}" != "success" ] || \
             [ "${{ needs.build-android.result }}" != "success" ]; then
            echo "One or more builds failed!"
            exit 1
          fi
          
          echo "All builds succeeded!"
